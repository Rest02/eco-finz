### **Contexto**

[] Este documento detalla el plan de acción para el desarrollo frontend del módulo de Finanzas. Toda la planificación se basa en las especificaciones, endpoints y modelos de datos definidos en el documento de backend: `3.detail_finanzas_module.md`. Sirve como guía para asegurar que el frontend se alinee correctamente con la lógica del servidor y mantenga los estándares de seguridad requeridos para que cualquier IA o desarrollador que se integre al proyecto pueda entenderlo para trabajar.

### **Buenas Prácticas para la IA**

*   **Seguir los Principios SOLID:**
    *   **S (Single Responsibility):** Cada componente, servicio o función debe tener una única responsabilidad.
    *   **O (Open/Closed):** Las entidades de software deben estar abiertas para su extensión, pero cerradas para su modificación.
    *   **L (Liskov Substitution):** Los objetos de una superclase deben poder ser reemplazados por objetos de una subclase sin afectar la corrección del programa.
    *   **I (Interface Segregation):** Ningún cliente debe ser forzado a depender de interfaces que no utiliza.
    *   **D (Dependency Inversion):** Los módulos de alto nivel no deben depender de los de bajo nivel. Ambos deben depender de abstracciones.
*   **Evitar la Redundancia (DRY - Don't Repeat Yourself):** Reutilizar código y lógica a través de componentes, hooks y servicios personalizados siempre que sea posible.
*   **Código Limpio y Legible:** Escribir código claro, conciso y bien documentado (cuando sea necesario). Seguir las convenciones de estilo del proyecto (`ESLint`).
*   **Modularidad:** Construir componentes y servicios que sean modulares e intercambiables.

### **Metodología de Trabajo**

1.  **Desarrollo por Fases:** La IA completará las tareas de una fase a la vez.
2.  **Notificación al Usuario:** Al finalizar todas las tareas de una fase, la IA informará al usuario que la fase ha sido completada y está lista para revisión.
3.  **Revisión del Usuario:** El usuario revisará el trabajo realizado. Si hay correcciones o ajustes, se los comunicará a la IA.
4.  **Iteración:** La IA y el usuario iterarán sobre los ajustes hasta que el usuario dé su aprobación.
5.  **Interacción con la Consola:** El usuario es el único responsable de ejecutar comandos en la terminal. Si se necesita ejecutar un comando (ej. `npm install`, `npm run dev`), la IA proporcionará el comando exacto y el usuario lo ejecutará.

---

### **Plan de Implementación Frontend: Módulo de Finanzas (Estructura Modular)**

[] El objetivo es construir la interfaz de usuario y la lógica de negocio para el módulo de finanzas, centralizando todo el código fuente relevante (excepto las páginas) dentro de la carpeta `src/finance` para una máxima modularidad.

#### **[x] Fase 1: Capa de Datos y Servicios (Fundamentos)**

[x] Esta fase se centra en establecer la comunicación con la API y definir las estructuras de datos necesarias, todo dentro de `src/finance`.

*   **[x] Tarea 1.1: Configuración de Variables de Entorno.**
    *   [x] Añadir la URL base de la API del backend en un archivo `.env.local` en la raíz del proyecto.

*   **[x] Tarea 1.2: Creación del Servicio de Finanzas (`financeService`).**
    *   [x] Crear la carpeta `src/finance/services`.
    *   [x] Dentro, crear un nuevo archivo `src/finance/services/financeService.ts`.
    *   [x] Este servicio centralizará todas las llamadas a los endpoints de finanzas y utilizará la instancia de `apiClient` existente.

*   **[x] Tarea 1.3: Definición de Tipos y DTOs en TypeScript.**
    *   [x] Crear la carpeta `src/finance/dto`.
    *   [x] Dentro, crear un archivo `src/finance/dto/finance.ts`.
    *   [x] Este archivo contendrá todas las interfaces y tipos del módulo de finanzas.

#### **[x] Fase 2: Componentes Reutilizables de la Interfaz (UI)**

[x] En esta fase, construiremos los bloques visuales de forma aislada dentro de `src/finance/components`.

*   **[x] Tarea 2.1: Creación de la carpeta de componentes.**
    *   [x] Crear la carpeta `src/finance/components`.

*   **[x] Tarea 2.2: Componente `AccountList`.**
    *   [x] Crear el archivo `src/finance/components/AccountList.tsx`.
    *   [x] Será un componente que recibe un array de `FinancialAccount` y las muestra.

*   **[x] Tarea 2.3: Componente `AccountForm`.**
    *   [x] Crear el archivo `src/finance/components/AccountForm.tsx`.
    *   [x] Contendrá el formulario para crear/editar una cuenta.

*   **[x] Tarea 2.4: Componente `TransactionList` (antes `MovementList`).**
    *   [x] Crear el archivo `src/finance/components/TransactionList.tsx`.
    *   [x] Mostrará las transacciones de una cuenta.

#### **[x] Fase 3: Integración en Páginas y Manejo de Estado**

[x] Aquí uniremos la capa de datos con los componentes de UI. Las páginas seguirán en `src/app` como requiere Next.js.

*   **[x] Nota sobre la estructura de páginas:** El App Router de Next.js requiere que las rutas y sus archivos (`page.tsx`, `layout.tsx`) residan en el directorio `src/app`. Por lo tanto, crearemos las páginas en `src/app/finance/...` e importaremos los componentes desde `src/finance/components`.

*   **[x] Tarea 3.1: Creación de la Página del Dashboard de Finanzas.**
    *   [x] Crear la ruta y página `src/app/finance/dashboard/page.tsx`.
    *   [x] Esta página importará y usará el servicio desde `src/finance/services/financeService` y los componentes desde `src/finance/components`.

*   **[x] Tarea 3.2: Creación de la Página de Detalle de Cuenta.**
    *   [x] Crear la ruta dinámica `src/app/finance/accounts/[id]/page.tsx`.
    *   [x] Importará y usará los componentes y servicios del módulo `src/finance`.

*   **[x] Tarea 3.3: Protección de Rutas del Módulo.**
    *   [x] Asegurar que las páginas bajo `src/app/finance` estén protegidas usando el `ProtectedRoute` existente.

#### **[x] Fase 4: Implementación de Funcionalidades CRUD**

[x] Con todo conectado, el último paso es hacer que la aplicación sea interactiva.

*   **[x] Tarea 4.1: Funcionalidad de Crear Cuenta.**
    *   [x] En el dashboard, usar el componente `AccountForm` (de `src/finance/components`) para crear cuentas llamando al `financeService`.

*   **[x] Tarea 4.2: Funcionalidad de Eliminar Cuenta.**
    *   [x] Implementar la lógica de eliminación en el `AccountList` llamando al `financeService`.

*   **[x] Tarea 4.3: Funcionalidad de Añadir Movimiento.**
    *   [x] En la página de detalle, usar un formulario para añadir movimientos llamando al `financeService`.

*   **[x] Tarea 4.4: Funcionalidad de "Transacción Rápida" en el Dashboard.**
    *   [x] Integrar el `TransactionForm` en el Dashboard principal con selector de cuenta dinámico.

*   **[x] Tarea 4.5: Funcionalidad de Eliminar Transacción.**
    *   [x] Implementar botón de borrado en `TransactionList` y lógica de eliminación en la página de detalle.

#### **[x] Fase 5: Gestión de Categorías (CRUD)**

[x] Esta fase se centrará en construir la interfaz y la lógica para que el usuario pueda administrar sus propias categorías de ingresos y egresos.

*   **[x] Tarea 5.1: Creación de la Página de Categorías.**
    *   [x] Crear la ruta y el archivo de página en `src/app/finance/categories/page.tsx`.
    *   [x] Esta página será el centro de la gestión de categorías.

*   **[x] Tarea 5.2: Componente `CategoryForm`.**
    *   [x] Crear un nuevo componente reutilizable en `src/finance/components/CategoryForm.tsx`.
    *   [x] Este formulario permitirá al usuario crear nuevas categorías (`{ "name": "...", "type": "..." }`).

*   **[x] Tarea 5.3: Componente `CategoryList`.**
    *   [x] Crear un nuevo componente reutilizable en `src/finance/components/CategoryList.tsx`.
    *   [x] Mostrará una lista de las categorías existentes.
    *   [x] Cada elemento de la lista incluirá un botón para "Eliminar".

*   **[x] Tarea 5.4: Implementación de Funcionalidades CRUD.**
    *   [x] En la página `categories/page.tsx`, integrar los componentes `CategoryForm` y `CategoryList`.
    *   [x] Utilizar las funciones `getCategories`, `createCategory`, y `deleteCategory` del `financeService` para implementar la lógica.

*   **[x] Tarea 5.5: Enlace a la Gestión de Categorías.**
    *   [x] Añadir un enlace en la página de `dashboard` para que el usuario pueda navegar fácilmente a la nueva página de gestión de categorías.

*   **[x] Tarea 5.6: Detector de Uso de Categorías.**
    *   [x] Implementar contador de transacciones y vista expandible de uso en `CategoryList`.

*   **[x] Tarea 5.7: Manejo de Errores de Integridad Referencial.**
    *   [x] Mostrar mensajes claros cuando una categoría no puede borrarse por estar en uso.

#### **[x] Fase 6: Gestión de Presupuestos (CRUD)**

[x] Esta fase implementará la funcionalidad que permite a los usuarios definir y gestionar sus metas de gasto mensuales por categoría.

*   **[x] Tarea 6.1: Extender `financeService` para Presupuestos.**
    *   [x] En `src/finance/services/financeService.ts`, añadir las funciones para interactuar con los endpoints de presupuestos: `getBudgets(year, month)`, `createBudget`, `updateBudget(id, data)` y `deleteBudget(id)`.

*   **[x] Tarea 6.2: Crear Página de Gestión de Presupuestos.**
    *   [x] Crear la ruta y el archivo de página en `src/app/finance/budgets/page.tsx`.
    *   [x] Servirá como el centro para que el usuario vea y administre todos sus presupuestos.

*   **[x] Tarea 6.3: Componente `BudgetForm`.**
    *   [x] Crear un componente reutilizable en `src/finance/components/BudgetForm.tsx`.
    *   [x] El formulario debe incluir campos para `name`, `amount`, `month`, `year` y un selector (`<select>`) para `categoryId`. El selector se poblará con las categorías de tipo "EGRESO" obtenidas de `getCategories`.

*   **[x] Tarea 6.4: Componente `BudgetList`.**
    *   [x] Crear un componente en `src/finance/components/BudgetList.tsx`.
    *   [x] Mostrará una lista de los presupuestos del mes/año seleccionado, permitiendo editar (abrir `BudgetForm` con datos precargados) y eliminar cada uno.

*   **[x] Tarea 6.5: Integración y Lógica en la Página.**
    *   [x] En `budgets/page.tsx`, integrar `BudgetForm` y `BudgetList`.
    *   [x] Añadir selectores para filtrar por `año` y `mes`.
    *   [x] Implementar la lógica para obtener y mostrar los presupuestos según el filtro y manejar las operaciones CRUD.

*   **[x] Tarea 6.6: Añadir Enlace de Navegación.**
    *   [x] En el layout principal del módulo de finanzas (ej. `src/app/finance/layout.tsx`) o en el dashboard, añadir un enlace para navegar a la página `/finance/budgets`.

#### **[x] Fase 7: Implementación del Resumen Mensual**

[x] Esta fase se centrará en visualizar el estado financiero consolidado del usuario en el dashboard principal, conectando transacciones, categorías y presupuestos.

*   **[x] Tarea 7.1: Extender `financeService` para el Resumen.**
    *   [x] En `src/finance/services/financeService.ts`, añadir la función `getMonthlySummary(year, month)` que llamará al endpoint `GET /finance/summary/:year/:month`.

*   **[x] Tarea 7.2: Componente Principal `MonthlySummary`.**
    *   [x] Crear un componente contenedor en `src/finance/components/MonthlySummary.tsx`.
    *   [x] Este componente recibirá los datos del resumen y orquestará la presentación de los sub-componentes.

*   **[x] Tarea 7.3: Sub-componentes de Visualización.**
    *   [x] **`DateSelector`:** Crear un pequeño componente (puede ser parte de `MonthlySummary`) con selectores para que el usuario elija el `año` y `mes` del resumen a consultar.
    *   [x] **`SummaryTotals`:** Crear un componente que muestre los totales (`totalIncome`, `totalExpenses`, `balance`) en un formato claro y visual (ej. tarjetas de estadísticas).
    *   [x] **`CategorySummaryList`:** Crear un componente que itere sobre el array `categorySummaries` y muestre para cada categoría: `categoryName`, `budgeted`, `spent` y `remaining`. Utilizar barras de progreso o colores para indicar visualmente el estado del gasto (ej. verde si está por debajo del presupuesto, rojo si lo ha excedido).

*   **[x] Tarea 7.4: Integración en el Dashboard.**
    *   [x] Modificar la página `src/app/finance/dashboard/page.tsx`.
    *   [x] Implementar la lógica de estado (`useState`, `useEffect`) para manejar el `año` y `mes` seleccionados.
    *   [x] Al cargar la página o cuando el usuario cambie la fecha, llamar a `getMonthlySummary` y pasar los datos al componente `MonthlySummary`.
    *   [x] Renderizar el componente `MonthlySummary` en el dashboard, reemplazando o complementando la vista actual.

*   **[x] Tarea 7.5: Sincronización en Tiempo Real del Dashboard.**
    *   [x] Actualización automática del resumen mensual tras crear transacciones rápidas.

*   **[x] Tarea 7.6: Sistema de Estilos Globales para Finanzas.**
    *   [x] Implementación de diseño premium (Glassmorphism, gradientes y animaciones) en `globals.css`.

#### **[x] Fase 8: Infraestructura y Robustez (Mejoras Técnicas)**

[x] Tareas transversales para asegurar la estabilidad y compatibilidad con el backend.

*   **[x] Tarea 8.1: Soporte para Respuestas Paginadas.**
    *   [x] Adaptar servicios y componentes para manejar la estructura `{ data: [], meta: {} }` del backend.

*   **[x] Tarea 8.2: Implementación de Programación Defensiva.**
    *   [x] Validación de tipos y arrays (`Array.isArray`) en todos los puntos de consumo de datos para evitar errores de ejecución.

#### **[x] Fase 9: Funcionalidad de Edición Completa (Completing CRUD)**

[x] Esta fase implementará la capacidad de actualizar (PATCH) las entidades principales, completando el ciclo CRUD que estaba pendiente para cuentas, categorías y transacciones.

*   **[x] Tarea 9.1: Servicio de Actualización.**
    *   [x] Asegurar que `financeService.ts` tenga implementados los métodos `updateAccount`, `updateCategory` y `updateTransaction`.

*   **[x] Tarea 9.2: Edición de Cuentas.**
    *   [x] Modificar `AccountList` para incluir un botón "Editar".
    *   [x] Adaptar `AccountForm` para aceptar datos iniciales (modo edición).
    *   [x] En el dashboard, implementar la lógica para cargar los datos en el formulario y enviar la actualización.

*   **[x] Tarea 9.3: Edición de Categorías.**
    *   [x] Modificar `CategoryList` para incluir un botón "Editar".
    *   [x] Adaptar `CategoryForm` para modo edición.
    *   [x] Implementar la lógica de actualización en `categories/page.tsx`.

*   **[x] Tarea 9.4: Edición de Transacciones.**
    *   [x] Modificar `TransactionList` para permitir acciones de edición en cada fila.
    *   [x] Reutilizar `TransactionForm` para permitir la edición, precargando fecha, monto, descripción, cuenta y categoría.
    *   [x] Implementar la lógica en la página de detalle de cuenta (donde se listan las transacciones).

#### **[] Fase 10: Filtrado Avanzado y Mejoras de UX**

[] Implementación de capacidades de búsqueda y filtrado para manejar mejor el historial de transacciones, aprovechando los parámetros opcionales del backend.

*   **[] Tarea 10.1: Componente `TransactionFilters`.**
    *   [] Crear `src/finance/components/TransactionFilters.tsx`.
    *   [] Debe incluir inputs/selects para: Rango de Fechas (desde/hasta), Tipo (Ingreso/Egreso) y Categoría.

*   **[] Tarea 10.2: Integración de Filtros en `financeService`.**
    *   [] Actualizar `getTransactions` (y la llamada en `getAccountTransactions` si aplica) para aceptar un objeto de filtros y construir la query string (`?startDate=...&type=...`).

*   **[] Tarea 10.3: Conexión en la Interfaz.**
    *   [] En la página de detalle de cuenta (`accounts/[id]/page.tsx`), integrar `TransactionFilters`.
    *   [] Al cambiar un filtro, recargar la lista de transacciones llamando al servicio con los nuevos parámetros.
