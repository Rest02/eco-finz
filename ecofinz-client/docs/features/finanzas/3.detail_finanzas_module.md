# Módulo de Finanzas: Documentación Integral

Este documento ofrece una guía completa del módulo de finanzas de **EcoFinz**. Está dividido en dos secciones principales:
1.  **Flujo Lógico y Modelo Conceptual:** Explica cómo un usuario interactúa con el sistema desde un punto de vista funcional.
2.  **Guía de API para Frontend:** Proporciona los detalles técnicos de cada endpoint para su implementación en el cliente.

---

## 1. Flujo Lógico y Modelo Conceptual

Esta sección describe el recorrido del usuario y la lógica detrás de la organización de sus datos financieros.

El flujo se puede dividir en dos etapas:
*   **Etapa de Configuración (Tareas iniciales u ocasionales):** El usuario define su "universo financiero" creando cuentas y categorías.
*   **Etapa de Registro (Tareas del día a día):** El usuario anota sus movimientos de dinero.

### Paso 1: El Usuario es el Centro de Todo

-   **Propietario de los Datos:** Todo en el sistema le pertenece a un `Usuario` específico.
-   **Autenticación:** Cuando un usuario inicia sesión, la API le entrega un **token JWT**.
-   **Seguridad:** En cada petición a la API (crear una cuenta, registrar un gasto, etc.), ese token debe viajar en la cabecera `Authorization`. El backend usa el `userId` contenido en el token para garantizar que un usuario solo pueda ver y gestionar sus propios datos.

### Paso 2: Crear los "Contenedores" de Dinero (Cuentas - `Account`)

-   **¿Qué son?:** Son los lugares físicos o virtuales donde el usuario tiene su dinero.
-   **Ejemplos:** "Banco Nación", "Billetera", "Mercado Pago", "Tarjeta Naranja".
-   **Proceso:**
    1.  El usuario, a través de la interfaz, realiza una petición `POST /account` con `{"name": "Banco Nación", "type": "BANCO", "balance": 50000}`.
    2.  El backend asocia esta nueva cuenta al `userId` del token.
    3.  Ahora existe una cuenta llamada "Banco Nación" que le pertenece exclusivamente a ese usuario.

### Paso 3: Crear las "Etiquetas" del Dinero (Categorías - `Category`)

-   **¿Qué son?:** Son las etiquetas que el usuario utiliza para clasificar sus movimientos. Le ayudan a entender en qué gasta o de dónde vienen sus ingresos.
-   **Ejemplos:** "Sueldo", "Alquiler", "Supermercado", "Transporte".
-   **Proceso:**
    1.  El usuario realiza una petición `POST /category` con `{"name": "Supermercado", "type": "EGRESO"}`.
    2.  El backend asocia esta nueva categoría al `userId` del token.
    3.  Ahora existe la categoría "Supermercado" disponible para ese usuario.

### Paso 4: Registrar el Movimiento (Transacciones - `Transaction`)

Aquí es donde todo se conecta. Una transacción es el evento que une una `Cuenta` con una `Categoría` para un `Usuario`.

-   **¿Qué es?:** Es el registro de un movimiento de dinero real. "Gasté $10,000 en el Supermercado desde mi cuenta del Banco Nación".
-   **Proceso:**
    1.  El usuario realiza una petición `POST /transaction` con los detalles: el monto, la fecha, el `accountId` (ID de "Banco Nación") y el `categoryId` (ID de "Supermercado").
    2.  El backend recibe la petición y realiza validaciones cruciales:
        -   Verifica que la `Cuenta` (`accountId`) pertenezca al usuario del token.
        -   Verifica que la `Categoría` (`categoryId`) pertenezca al mismo usuario.
    3.  Si ambas validaciones son correctas, crea el registro de la `Transaction`.
    4.  Si alguna validación falla, devuelve un error, previniendo que un usuario use accidental o maliciosamente las cuentas o categorías de otro.

### Paso 5: Planificar y Analizar (Presupuestos y Resumen)

-   **¿Qué son los Presupuestos (`Budget`)?:** Son metas de gasto que el usuario define para un mes y una categoría específica. Por ejemplo: "Este mes no quiero gastar más de $20,000 en Supermercado". Se crean con una petición `POST /budget`.
-   **¿Qué es el Resumen (`Summary`)?:** Es el análisis final que le da sentido a todo. Mediante una petición `GET /finance/summary/:year/:month`, el frontend puede obtener un reporte completo que muestra:
    -   Totales de ingresos y egresos.
    -   El balance final.
    -   Una comparación de los gastos reales (`Transaction`) contra los objetivos de gasto (`Budget`) para cada categoría.

---

## 2. Guía de API para Frontend

Esta sección contiene los detalles técnicos de cada endpoint.

### Requisitos Globales

#### Autenticación

Todos los endpoints listados a continuación están protegidos. El frontend **debe** incluir el token JWT del usuario en la cabecera de cada petición:

-   **Header:** `Authorization`
-   **Value:** `Bearer <JWT_TOKEN>`

### 2.1. Resumen Mensual (Summary)

Endpoint principal para obtener una vista consolidada del estado financiero del usuario para un mes específico.

#### `GET /finance/summary/:year/:month`

Calcula y devuelve los totales de ingresos, egresos, el balance y un desglose de gastos por categoría comparado con los presupuestos.

-   **Parámetros de URL:**
    -   `year` (número): El año a consultar. Ej: `2026`.
    -   `month` (número): El mes a consultar (1 para Enero, 12 para Diciembre). Ej: `1`.
-   **Ejemplo de Petición (`fetch` en JavaScript):**
    ```javascript
    const year = 2026;
    const month = 1;
    const response = await fetch(`http://localhost:3000/finance/summary/${year}/${month}`, {
      headers: {
        'Authorization': 'Bearer <JWT_TOKEN>'
      }
    });
    const summaryData = await response.json();
    ```
-   **Respuesta Exitosa (200 OK):**
    ```json
    {
      "totalIncome": 50000.00,
      "totalExpenses": 25000.00,
      "balance": 25000.00,
      "categorySummaries": [
        {
          "categoryId": "clx...",
          "categoryName": "Comida",
          "budgeted": 10000.00,
          "spent": 8500.00,
          "remaining": 1500.00
        },
        {
          "categoryId": "cly...",
          "categoryName": "Transporte",
          "budgeted": 5000.00,
          "spent": 5500.00,
          "remaining": -500.00
        }
      ]
    }
    ```

### 2.2. Categorías (Categories)

Gestiona las etiquetas que el usuario utiliza para clasificar sus transacciones.

-   `GET /category`
-   `POST /category`
-   `PATCH /category/:id`
-   `DELETE /category/:id`

#### DTOs de Categoría

-   **`CreateCategoryDto` (para `POST`):**
    ```json
    {
      "name": "Educación",
      "type": "EGRESO" // "INGRESO" o "EGRESO"
    }
    ```
-   **`UpdateCategoryDto` (para `PATCH`):** (campos opcionales)
    ```json
    {
      "name": "Educación y Cursos"
    }
    ```

### 2.3. Cuentas (Accounts)

Gestiona las cuentas del usuario (bancos, efectivo, etc.).

-   `GET /account`
-   `POST /account`
-   `PATCH /account/:id`
-   `DELETE /account/:id`

#### DTOs de Cuenta

-   **`CreateAccountDto` (para `POST`):**
    ```json
    {
      "name": "Billetera Digital",
      "type": "BILLETERA_DIGITAL", // BANCO, EFECTIVO, TARJETA_CREDITO, BILLETERA_DIGITAL
      "balance": 500.00
    }
    ```
-   **`UpdateAccountDto` (para `PATCH`):** (campos opcionales)
    ```json
    { "name": "Banco Secundario" }
    ```

### 2.4. Transacciones (Transactions)

Registra los movimientos de dinero.

-   `GET /transaction` (con filtros opcionales en query params)
-   `POST /transaction`
-   `PATCH /transaction/:id`
-   `DELETE /transaction/:id`

#### DTOs de Transacción

-   **`CreateTransactionDto` (para `POST`):**
    ```json
    {
      "amount": 150.50,
      "type": "EGRESO", // INGRESO o EGRESO
      "description": "Almuerzo de trabajo",
      "date": "2026-01-15T12:00:00Z", // Formato ISO 8601
      "accountId": "cl_id_de_la_cuenta",
      "categoryId": "cl_id_de_la_categoria"
    }
    ```
-   **`UpdateTransactionDto` (para `PATCH`):** (campos opcionales)

### 2.5. Presupuestos (Budgets)

Define los límites de gasto mensual por categoría.

-   `GET /budget` (con filtros opcionales en query params `?month=1&year=2026`)
-   `POST /budget`
-   `PATCH /budget/:id`
-   `DELETE /budget/:id`

#### DTOs de Presupuesto

-   **`CreateBudgetDto` (para `POST`):**
    ```json
    {
      "name": "Presupuesto Comida Enero",
      "amount": 10000.00,
      "month": 1,
      "year": 2026,
      "categoryId": "cl_id_de_la_categoria_comida"
    }
    ```
-   **`UpdateBudgetDto` (para `PATCH`):** (campos opcionales)
