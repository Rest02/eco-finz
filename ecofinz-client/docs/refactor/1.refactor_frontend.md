# Plan de Refactorización Frontend: Arquitectura y Estado

Este documento detalla el plan de trabajo para modernizar la arquitectura del proyecto `ecofinz-client` y optimizar la gestión del estado del servidor.

**Objetivos Principales:**
1.  **Consistencia Arquitectónica:** Migrar a una estructura basada en `features` (módulos), unificando la organización de `Auth` y `Finance`.
2.  **Gestión de Estado (Server State):** Implementar **TanStack Query (React Query)** para eliminar la gestión manual de `useEffect/useState` y `loading` states, mejorando el rendimiento y la mantenibilidad.

---

## Estructura de Directorios Objetivo

Al finalizar este plan, la estructura principal del código fuente (`src/`) será:

```text
src/
├── app/                  # Solo Rutas y Layouts (Next.js App Router)
├── components/           # UI Kit y Componentes Globales
├── lib/                  # Configuraciones (axios, react-query, utils)
├── features/             # Lógica de Negocio Modular
│   ├── auth/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── services/
│   │   └── types/
│   └── finance/
│       ├── components/
│       ├── hooks/        # Nuevos hooks de React Query
│       ├── services/
│       └── types/        # (Antes dto/)
```

---

## Fases de Implementación

### [x] Fase 1: Infraestructura y Configuración

Esta fase prepara el terreno instalando las dependencias necesarias y configurando el proveedor global de estado.

*   **[x] Tarea 1.1: Instalación de Dependencias.**
    *   [x] Instalar `@tanstack/react-query`.
    *   [x] Instalar `@tanstack/react-query-devtools` (opcional, recomendado para desarrollo).

*   **[x] Tarea 1.2: Configuración del Cliente de Query.**
    *   [x] Crear archivo `src/lib/react-query.ts` para instanciar el `QueryClient`.
    *   [x] Configurar opciones por defecto (ej. `staleTime`, `refetchOnWindowFocus`).

*   **[x] Tarea 1.3: Integración en el Layout Principal.**
    *   [x] Modificar `src/app/layout.tsx` para envolver la aplicación con el `QueryClientProvider`.

*   **[x] Tarea 1.4: Creación de Estructura Base.**
    *   [x] Crear el directorio `src/features`.
    *   [x] Crear subdirectorios `src/features/auth` y `src/features/finance`.

---

### [x] Fase 2: Migración y Estandarización de Auth

Movemos la lógica de autenticación dispersa a su nuevo hogar modular.

*   **[x] Tarea 2.1: Migración de Tipos y Servicios.**
    *   [x] Mover `src/types/auth.ts` -> `src/features/auth/types/auth.ts`.
    *   [x] Mover `src/services/authService.ts` -> `src/features/auth/services/authService.ts`.
    *   [x] Actualizar importaciones en el servicio (si referenciaba tipos antiguos).

*   **[x] Tarea 2.2: Migración de Componentes.**
    *   [x] Mover componentes de `src/components/auth/*` -> `src/features/auth/components/*`.
    *   [x] (Opcional) Si existe un Contexto de Auth, moverlo a `src/features/auth/context` o `hooks`.

*   **[x] Tarea 2.3: Actualización de Referencias.**
    *   [x] Actualizar todas las importaciones en `src/app/(auth)/*` y `src/middleware.ts` (si aplica) para apuntar a las nuevas rutas en `src/features/auth`.
    *   [x] Eliminar las carpetas antiguas `src/components/auth`, `src/services` (si queda vacía) y `src/types` (si queda vacía).

---

### [] Fase 3: Migración del Módulo Finance

Movemos el módulo de finanzas actual a la nueva estructura `features`, sin cambiar la lógica interna todavía.

*   **[] Tarea 3.1: Reubicación de Archivos.**
    *   Mover todo el contenido de `src/finance/*` -> `src/features/finance/*`.
    *   Renombrar carpeta `src/features/finance/dto` -> `src/features/finance/types` para consistencia con Auth (o mantener DTO si se prefiere, pero estandarizar).

*   **[] Tarea 3.2: Actualización de Referencias en App.**
    *   Actualizar importaciones en todas las páginas de `src/app/finance/*` para que apunten a `src/features/finance/*`.
    *   Verificar que la aplicación compile y funcione igual que antes de la mudanza.

---

### [] Fase 4: Implementación de React Query (Finance)

Reemplazamos la lógica manual de fetch (`useEffect`) por Hooks personalizados de React Query. Esta es la mejora clave de "Gestión de Estado".

*   **[] Tarea 4.1: Hooks de Cuentas (Accounts).**
    *   Crear `src/features/finance/hooks/useAccounts.ts`.
    *   Implementar `useAccounts` (Query) para obtener listado.
    *   Implementar `useCreateAccount`, `useUpdateAccount`, `useDeleteAccount` (Mutations) con invalidación de caché (Invalidate Queries).

*   **[] Tarea 4.2: Refactorización de UI - Cuentas.**
    *   Actualizar `src/features/finance/components/AccountList.tsx` y el Dashboard para usar estos hooks.
    *   Eliminar `useState` para `accounts` y `useEffect` de carga manual. Manejar estados `isLoading` y `isError` nativos de React Query.

*   **[] Tarea 4.3: Hooks de Transacciones (Transactions).**
    *   Crear `src/features/finance/hooks/useTransactions.ts`.
    *   Implementar `useTransactions` (con soporte para filtros) y las mutaciones correspondientes.

*   **[] Tarea 4.4: Refactorización de UI - Transacciones.**
    *   Actualizar `src/app/finance/accounts/[id]/page.tsx` para usar los hooks.
    *   Hacer que los filtros (TransactionFilters) pasen parámetros directamente al hook `useTransactions`.

*   **[] Tarea 4.5: Hooks y Refactorización de Categorías.**
    *   Crear `src/features/finance/hooks/useCategories.ts`.
    *   Refactorizar `src/app/finance/categories/page.tsx` eliminando la lógica manual.

*   **[] Tarea 4.6: Hooks y Refactorización de Presupuestos y Resumen.**
    *   Crear `src/features/finance/hooks/useBudgets.ts` y `useMonthlySummary.ts`.
    *   Refactorizar Dashboard y página de Presupuestos.

---

### [] Fase 5: Limpieza y Verificación

*   **[] Tarea 5.1: Limpieza de Código Muerto.**
    *   Buscar y eliminar cualquier archivo de servicio antiguo que ya no se use (ahora envuelto en hooks).
    *   Eliminar estados locales redundantes.

*   **[] Tarea 5.2: Pruebas Manuales.**
    *   Verificar flujo completo: Login -> Dashboard -> Crear Cuenta -> Crear Transacción -> Ver Resumen -> Logout.
